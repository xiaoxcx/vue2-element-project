name: Vue2 Element UI - Auto Deploy

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  # æ‰‹åŠ¨è§¦å‘éƒ¨ç½²
  workflow_dispatch:
    inputs:
      environment:
        description: 'éƒ¨ç½²ç¯å¢ƒ'
        required: true
        default: 'production'
        type: choice
        options:
        - production
        - staging

env:
  NODE_VERSION: '18'
  PUBLIC_PATH: '/vue2-element-project/'

jobs:
  # ä»£ç è´¨é‡æ£€æŸ¥
  quality-check:
    name: "ä»£ç è´¨é‡æ£€æŸ¥"
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: è®¾ç½®Node.jsç¯å¢ƒ
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'yarn'

    - name: å®‰è£…ä¾èµ–
      run: yarn install --frozen-lockfile --prefer-offline

    - name: ä»£ç å®‰å…¨æ£€æŸ¥
      run: |
        echo "ğŸ” å¼€å§‹ä»£ç å®‰å…¨æ£€æŸ¥..."
        # æ£€æŸ¥æ•æ„Ÿä¿¡æ¯
        if grep -r "password\|secret\|token" --include="*.js" --include="*.vue" --include="*.json" src/ public/; then
          echo "âš ï¸  å‘ç°å¯èƒ½çš„æ•æ„Ÿä¿¡æ¯ï¼Œè¯·æ£€æŸ¥ä»£ç "
          exit 1
        else
          echo "âœ… ä»£ç å®‰å…¨æ£€æŸ¥é€šè¿‡"
        fi

    - name: æ„å»ºäº§ç‰©æ£€æŸ¥
      run: |
        echo "ğŸ—ï¸  å¼€å§‹æ„å»ºé¡¹ç›®..."
        yarn build
        
        echo "ğŸ“ æ£€æŸ¥æ„å»ºè¾“å‡º..."
        if [ ! -d "dist" ]; then
          echo "âŒ distç›®å½•ä¸å­˜åœ¨ï¼Œæ„å»ºå¤±è´¥"
          exit 1
        fi
        
        echo "ğŸ“Š æ„å»ºäº§ç‰©ç»Ÿè®¡:"
        find dist -type f -name "*.js" -o -name "*.css" -o -name "*.html" | wc -l
        du -sh dist/
        
        echo "âœ… æ„å»ºæ£€æŸ¥é€šè¿‡"

    - name: ä¸Šä¼ æ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: build-artifacts
        path: |
          dist/
        retention-days: 3

  # è‡ªåŠ¨åŒ–æµ‹è¯•
  automated-tests:
    name: "è‡ªåŠ¨åŒ–æµ‹è¯•"
    runs-on: ubuntu-latest
    needs: quality-check
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½®Node.jsç¯å¢ƒ
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'yarn'

    - name: å®‰è£…ä¾èµ–
      run: yarn install --frozen-lockfile

    - name: è¿è¡ŒåŸºç¡€æµ‹è¯•
      run: |
        echo "ğŸ§ª å¼€å§‹è¿è¡Œæµ‹è¯•..."
        
        # æ£€æŸ¥æ„å»ºé…ç½®
        if [ -f "vue.config.js" ]; then
          echo "âœ… vue.config.js é…ç½®æ­£å¸¸"
        else
          echo "âŒ vue.config.js æ–‡ä»¶ç¼ºå¤±"
          exit 1
        fi
        
        # æ£€æŸ¥è·¯ç”±é…ç½®
        if [ -f "src/router/index.js" ]; then
          echo "âœ… è·¯ç”±é…ç½®æ­£å¸¸"
        else
          echo "âš ï¸  è·¯ç”±é…ç½®æ–‡ä»¶å¯èƒ½ç¼ºå¤±"
        fi
        
        # è¿è¡Œæ„å»ºæµ‹è¯•
        yarn build
        
        # æ£€æŸ¥æ„å»ºäº§ç‰©
        if [ -f "dist/index.html" ]; then
          echo "âœ… index.html ç”Ÿæˆæ­£å¸¸"
          # æ£€æŸ¥HTMLæ–‡ä»¶å®Œæ•´æ€§
          if grep -q "<div id=\"app\">" dist/index.html; then
            echo "âœ… Vueåº”ç”¨æŒ‚è½½ç‚¹æ­£å¸¸"
          else
            echo "âŒ Vueåº”ç”¨æŒ‚è½½ç‚¹å¼‚å¸¸"
            exit 1
          fi
        else
          echo "âŒ index.html ç”Ÿæˆå¤±è´¥"
          exit 1
        fi
        
        echo "ğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡"

  # ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²
  deploy-production:
    name: "éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ"
    runs-on: ubuntu-latest
    needs: [quality-check, automated-tests]
    if: github.ref == 'refs/heads/main'
    environment: production
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½®Node.jsç¯å¢ƒ
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'yarn'

    - name: å®‰è£…ä¾èµ–
      run: yarn install --frozen-lockfile

    - name: æ„å»ºç”Ÿäº§ç‰ˆæœ¬
      run: |
        echo "ğŸš€ å¼€å§‹ç”Ÿäº§ç¯å¢ƒæ„å»º..."
        NODE_ENV=production yarn build
        
        echo "ğŸ“‹ æ„å»ºäº§ç‰©æ¸…å•:"
        find dist -type f | sort
        
        # éªŒè¯æ„å»ºäº§ç‰©
        if [ ! -f "dist/index.html" ]; then
          echo "âŒ æ„å»ºå¤±è´¥: index.html ä¸å­˜åœ¨"
          exit 1
        fi
        
        echo "âœ… ç”Ÿäº§æ„å»ºå®Œæˆ"

    - name: é…ç½®GitHub Pageséƒ¨ç½²
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./dist
        publish_branch: gh-pages
        force_orphan: true
        user_name: 'github-actions[bot]'
        user_email: 'github-actions[bot]@users.noreply.github.com'
        commit_message: "ğŸš€ Deploy: ${{ github.sha }}"

    - name: éƒ¨ç½²æˆåŠŸé€šçŸ¥
      run: |
        echo "ğŸ‰ éƒ¨ç½²æˆåŠŸ!"
        echo "ğŸŒ è®¿é—®åœ°å€: https://xiaoxcx.github.io/vue2-element-project/"
        echo "ğŸ“… éƒ¨ç½²æ—¶é—´: $(date)"
        echo "ğŸ”— Commit: ${{ github.sha }}"

  # éƒ¨ç½²åéªŒè¯
  post-deploy-verify:
    name: "éƒ¨ç½²åéªŒè¯"
    runs-on: ubuntu-latest
    needs: deploy-production
    if: always()
    
    steps:
    - name: ç­‰å¾…éƒ¨ç½²å®Œæˆ
      run: |
        echo "â³ ç­‰å¾…GitHub Pageséƒ¨ç½²å®Œæˆ..."
        sleep 60  # ç­‰å¾…1åˆ†é’Ÿè®©Pageséƒ¨ç½²å®Œæˆ

    - name: éªŒè¯ç½‘ç«™å¯è®¿é—®æ€§
      run: |
        echo "ğŸ” å¼€å§‹éªŒè¯ç½‘ç«™å¯è®¿é—®æ€§..."
        
        # ä½¿ç”¨curlæ£€æŸ¥ç½‘ç«™çŠ¶æ€
        STATUS_CODE=$(curl -s -o /dev/null -w "%{http_code}" https://xiaoxcx.github.io/vue2-element-project/ || echo "000")
        
        if [ "$STATUS_CODE" = "200" ]; then
          echo "âœ… ç½‘ç«™å¯æ­£å¸¸è®¿é—® (HTTP 200)"
        elif [ "$STATUS_CODE" = "404" ]; then
          echo "âš ï¸  ç½‘ç«™è¿”å›404ï¼Œå¯èƒ½è¿˜åœ¨éƒ¨ç½²ä¸­"
        else
          echo "âŒ ç½‘ç«™è®¿é—®å¼‚å¸¸ï¼ŒçŠ¶æ€ç : $STATUS_CODE"
        fi

    - name: å‘é€éƒ¨ç½²æŠ¥å‘Š
      if: always()
      run: |
        echo "ğŸ“Š éƒ¨ç½²æŠ¥å‘Š"
        echo "=========="
        echo "ä»“åº“: ${{ github.repository }}"
        echo "åˆ†æ”¯: ${{ github.ref }}"
        echo "æäº¤: ${{ github.sha }}"
        echo "è§¦å‘è€…: ${{ github.actor }}"
        echo "å·¥ä½œæµ: ${{ github.workflow }}"
        echo "ç»“æœ: ${{ job.status }}"
        echo "éƒ¨ç½²åœ°å€: https://xiaoxcx.github.io/vue2-element-project/"

  # æ¸…ç†å·¥ä½œ
  cleanup:
    name: "æ¸…ç†å·¥ä½œ"
    runs-on: ubuntu-latest
    needs: [deploy-production, post-deploy-verify]
    if: always()
    
    steps:
    - name: æ¸…ç†ç¼“å­˜
      run: |
        echo "ğŸ§¹ å¼€å§‹æ¸…ç†å·¥ä½œ..."
        # æ¸…ç†Node.jsç¼“å­˜
        yarn cache clean
        
    - name: å·¥ä½œæµå®Œæˆ
      run: |
        echo "ğŸ CI/CD å·¥ä½œæµæ‰§è¡Œå®Œæˆ"
        echo "================================"
        echo "ğŸ“ˆ æŸ¥çœ‹è¯¦ç»†æŠ¥å‘Š: https://github.com/${{ github.repository }}/actions"
        echo "ğŸŒ è®¿é—®ç½‘ç«™: https://xiaoxcx.github.io/vue2-element-project/"
        echo "ğŸ“š æ–‡æ¡£: https://github.com/${{ github.repository }}/blob/main/README.md"